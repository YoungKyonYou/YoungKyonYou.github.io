I"Ò1<p><span style="color:orange; font-weight:bold"><em>í•´ë‹¹ ë‚´ìš©ì€ ì±… â€˜ì½”ë“œë¡œ ë°°ìš°ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ ì›¹ í”„ë¡œì íŠ¸â€™ì— ë‚˜ì˜¤ëŠ” ë‚´ìš©ì´ë©° ì´ëŠ” ê°œì¸ì ìœ¼ë¡œ ê³µë¶€í•˜ê¸° ìœ„í•´ ê¸°ë¡í•¨ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤</em></span></p>

<p><br /><br /></p>

<h1 id="api-ì„œë²„ë¥¼-ìœ„í•œ-í•„í„°"><center>API ì„œë²„ë¥¼ ìœ„í•œ í•„í„°</center></h1>

<p><br /></p>

<p>ì§€ê¸ˆê¹Œì§€ ì‘ì„±í•œ â€˜/notesâ€™ë¼ëŠ” ê²½ë¡œëŠ” ì™¸ë¶€ì—ì„œ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ê¸° ìœ„í•œ ê²½ë¡œì´ë‹¤. ì´ ê²½ë¡œë¥¼ ì™¸ë¶€ì—ì„œ ì•„ë¬´ëŸ° ì œì•½ì—†ì´ í˜¸ì¶œí•˜ëŠ” ê²ƒì€ ì„œë²„ì— ìƒë‹¹í•œ ë¶€ë‹´ì„ ì£¼ê¸° ë•Œë¬¸ì— ì¸ì¦ì„ ê±°ì¹œ ì‚¬ìš©ìì— í•œí•´ì„œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê³ ì í•œë‹¤.</p>

<p><br /></p>

<p>ê¸°ì¡´ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì¿ í‚¤(Cookie)ë‚˜ ì„¸ì…˜(Session)ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë™ì¼í•œ ì‚¬ì´íŠ¸ì—ì„œë§Œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— API ì„œë²„ì²˜ëŸ¼ ì™¸ë¶€ì—ì„œ ììœ ë¡­ê²Œ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ë•ŒëŠ” ìœ ìš©í•˜ì§€ ëª»í•˜ë‹¤. ì™¸ë¶€ì—ì„œ APIë¥¼ í˜¸ì¶œí•  ë•ŒëŠ” ì£¼ë¡œ â€˜ì¸ì¦ ì •ë³´ë‚˜ ì¸ì¦ í‚¤(key)â€™ë¥¼ ê°™ì´ ì „ì†¡í•´ì„œ ì²˜ë¦¬í•œë‹¤.</p>

<p><br /></p>

<p>ì˜ˆë¥¼ ë“¤ì–´ ì•ì—ì„œ ì†Œì…œ ë¡œê·¸ì¸ì„ í•˜ê¸° ìœ„í•´ì„œ êµ¬ê¸€ì—ì„œ í‚¤(key)ë¥¼ ë°œê¸‰ë°›ì•„ì„œ ì‚¬ìš©í–ˆë“¯ì´ APIë¥¼ ì´ìš©í•  ë•Œ ìì‹ ì˜ ê³ ìœ í•œ í‚¤(key)ë¥¼ ê°™ì´ ì „ì†¡í•˜ê³  ì´ë¥¼ ì´ìš©í•´ì„œ í•´ë‹¹ ìš”ì²­ì´ ì •ìƒì ì¸ ì‚¬ìš©ìì„ì„ ì•Œì•„ë‚´ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤. ì´ëŸ¬í•œ í‚¤(key)ë¥¼ í† í°(token)ì´ë¼ëŠ” ìš©ì–´ë¡œ ì‚¬ìš©í•˜ê¸°ë„ í•˜ëŠ”ë° ì˜ˆì œì—ì„œëŠ” JWT(JSON Web Token)ë¼ëŠ” ê²ƒì„ ì´ìš©í•œë‹¤.</p>

<p><br /></p>

<p>ì™¸ë¶€ì—ì„œëŠ” íŠ¹ì •í•œ APIë¥¼ í˜¸ì¶œí•  ë•Œ ë°˜ë“œì‹œ ì¸ì¦ì— ì‚¬ìš©í•  í† í°ì„ ê°™ì´ ì „ì†¡í•˜ê³ , ì„œë²„ì—ì„œëŠ” ì´ë¥¼ ê²€ì¦í•œë‹¤. ì´ ê³¼ì •ì—ì„œ í•„ìš”í•œ ê²ƒì€ íŠ¹ì •í•œ URLì„ í˜¸ì¶œí•  ë•Œ ì „ë‹¬ëœ í† í°ì„ ê²€ì‚¬í•˜ëŠ” í•„í„°ì´ë‹¤. ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ëŠ” ì›í•˜ëŠ” í•„í„°ë¥¼ ì‚¬ìš©ìê°€ ì‘ì„±í•˜ê³  ì´ë¥¼ ì„¤ì •ì—ì„œ ì‹œíë¦¬í‹° ë™ì‘ì˜ ì¼ë¶€ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤. í•„í„°ë¥¼ ì¶”ê°€í•  ë•ŒëŠ” ê¸°ì¡´ì— ìˆëŠ” ì—¬ëŸ¬ í•„í„° ì‚¬ì´ì— ìœ„ì¹˜ì‹œí‚¬ ìˆ˜ ìˆë‹¤.</p>

<p><br /></p>

<p>ê°€ì¥ ë¨¼ì € ì‚´í´ë³¼ í•„í„°ëŠ” <strong>org.springframework.web.filter.OncePerRequestFilter</strong>ì´ë‹¤. OncePerRequestFilterëŠ” ì¶”ìƒ í´ë˜ìŠ¤ë¡œ ì œê³µë˜ëŠ” í•„í„°ë¡œ ê°€ì¥ ì¼ë°˜ì ì´ë©° ë§¤ë²ˆ ë™ì‘í•˜ëŠ” ê¸°ë³¸ì ì¸ í•„í„°ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤. OncePerRequestFilterëŠ” ì¶”ìƒ í´ë˜ìŠ¤ì´ë¯€ë¡œ ì´ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ìƒì†ìœ¼ë¡œ êµ¬í˜„í•´ì„œ ì‚¬ìš©í•œë‹¤. í”„ë¡œì íŠ¸ì— securiy íŒ¨í‚¤ì§€ ë‚´ì— filter íŒ¨í‚¤ì§€ë¥¼ ì¶”ê°€í•˜ê³ , ApiCheckFilterë¼ëŠ” í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤.</p>

<p><br /></p>

<p><img src="/images/Kubernetes/kubernetes-Prometheus/2021-08-09-15-48-25.png" alt="" /></p>

<p><br /></p>

<p><strong>ApiCheckFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.young.club.security.filter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.log4j.Log4j2</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.filter.OncePerRequestFilter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiCheckFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>

        <span class="c1">//ë‹¤ìŒ í•„í„°ì˜ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ëŠ” ì—­í• ì„ ìœ„í•´ì„œ í•„ìš”í•˜ë‹¤</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><br /></p>

<p>ê·¸ ë‹¤ìŒ SecurityConfigë¥¼ í†µí•´ì„œ ìŠ¤í”„ë§ì˜ ë¹ˆìœ¼ë¡œ ì„¤ì •í•œë‹¤.</p>

<p><strong>SecurityConfig.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ApiCheckFilter</span> <span class="nf">apiCheckFilter</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiCheckFilter</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>ApiCheckFilterì˜ ë™ì‘ ìˆœì„œë¥¼ ì¡°ì ˆí•˜ê³  ì‹¶ë‹¤ë©´ ê¸°ì¡´ì— ìˆëŠ” íŠ¹ì •í•œ í•„í„°ì˜ ì´ì „ì´ë‚˜ ë‹¤ìŒì— ë™ì‘í•˜ë„ë¡ ì§€ì •í•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì—¬ëŸ¬ í•„í„° ì¤‘ì—ì„œ UsernamePasswordAuthenticationFilterëŠ” ì‚¬ìš©ìì˜ ì•„ë””ì´(username)ì™€ íŒ¨ìŠ¤ì›Œë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ëŠ” í•„í„°ì´ë‹¤. ì¡°ê¸ˆ ì „ì— ì‘ì„±í•œ ApiCheckFilterë¥¼ UsernamePasswordAuthenticationFilter ì´ì „ì— ë™ì‘í•˜ë„ë¡ ì§€ì •í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•œë‹¤.</p>

<p><br /></p>

<p><strong>Securityconfig.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="o">(...)</span>
        <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">apiCheckFilter</span><span class="o">(),</span> <span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>í•„í„°ì˜ ìˆœì„œë¥¼ ì¡°ì •í•˜ê¸°ëŠ” í–ˆì§€ë§Œ ApiCheckFilterëŠ” ì˜¤ì§ <strong>â€˜/notes/..â€™</strong>ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°ì—ë§Œ ë™ì‘í•˜ëŠ”ê²Œ ë°”ëŒì§í•  ê²ƒì´ë‹¤.(ê¸°ì¡´ ë¡œê·¸ì¸ê³¼ ë‹¬ë¦¬ í† í° ê¸°ë°˜ì´ë¯€ë¡œ). ì´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ìœ¼ë¡œëŠ” AntPathMatcherë¼ëŠ” ê²ƒì„ ì‚¬ìš©í•œë‹¤. AntPathMatcherëŠ” ì—”íŠ¸ íŒ¨í„´(Ant Patternì€ ì¤‘ê°„ì— ?,*,** ì™€ ê°™ì€ ê¸°í˜¸ë¥¼ ì´ìš©í•´ì„œ íŒ¨í„´ì„ í‘œì‹œ)ì— ë§ëŠ”ì§€ë¥¼ ê²€ì‚¬í•˜ëŠ” ìœ í‹¸ë¦¬í‹°ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤. ApiCheckFilterì— ë¬¸ìì—´ë¡œ ëœ íŒ¨í„´ì„ ë„£ì–´ì„œ íŒ¨í„´ì— ë§ëŠ” ê²½ìš°ì—ëŠ” ë‹¤ë¥¸ ë™ì‘ì„ í•˜ë„ë¡ ë³€ê²½í•œë‹¤.</p>

<p><br /></p>

<p><strong>ApiCheckFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiCheckFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">AntPathMatcher</span> <span class="n">antPathMatcher</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">pattern</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">ApiCheckFilter</span><span class="o">(</span><span class="nc">String</span> <span class="n">pattern</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">antPathMatcher</span><span class="o">=</span><span class="k">new</span> <span class="nc">AntPathMatcher</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"REQUESTURI: "</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">());</span>
        
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">antPathMatcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">pattern</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">()));</span>
        <span class="k">if</span><span class="o">(</span><span class="n">antPathMatcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">pattern</span><span class="o">,</span><span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">())){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>
            
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>


        <span class="c1">//ë‹¤ìŒ í•„í„°ì˜ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ëŠ” ì—­í• ì„ ìœ„í•´ì„œ í•„ìš”í•˜ë‹¤</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<p>ë³€ê²½ëœ ApiCheckFilter í´ë˜ìŠ¤ëŠ” ë¬¸ìì—´ë¡œ íŒ¨í„´ì„ ì…ë ¥ë°›ëŠ” ìƒì„±ìê°€ ì¶”ê°€ë˜ì—ˆìœ¼ë¯€ë¡œ SecurityConfigë¥¼ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•œë‹¤.</p>

<p><br /></p>

:ET