I"ÂG<p><span style="color:orange; font-weight:bold"><em>í•´ë‹¹ ë‚´ìš©ì€ ì±… â€˜ì½”ë“œë¡œ ë°°ìš°ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ ì›¹ í”„ë¡œì íŠ¸â€™ì— ë‚˜ì˜¤ëŠ” ë‚´ìš©ì´ë©° ì´ëŠ” ê°œì¸ì ìœ¼ë¡œ ê³µë¶€í•˜ê¸° ìœ„í•´ ê¸°ë¡í•¨ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤</em></span></p>

<p><br /><br /></p>

<h1 id="apië¥¼-ìœ„í•œ-ì¸ì¦ì²˜ë¦¬"><center>APIë¥¼ ìœ„í•œ ì¸ì¦ì²˜ë¦¬</center></h1>

<p><br /></p>

<p>APIë¥¼ ì´ìš©í•œë‹¤ë©´ ì¼ë°˜ì ì¸ ë¡œê·¸ì¸ì˜ URLì´ ì•„ë‹Œ ë³„ë„ì˜ URLë¡œ ë¡œê·¸ì¸ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì´ë‹¤. í¼ ë°©ì‹ì˜ ë¡œê·¸ì¸ê³¼ ë‹¬ë¦¬ APIëŠ” URLì´ ë³€ê²½ë˜ë©´ APIë¥¼ ì´ìš©í•˜ëŠ” ì…ì¥ì—ì„œëŠ” í˜¸ì¶œí•˜ëŠ” URLë¥¼ ë³€ê²½í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ìœ„í—˜í•œ ì¼ì´ë‹¤.</p>

<p>ì˜ˆì œëŠ” ApiLoginFilterë¥¼ ì‘ì„±í•œë‹¤. ApiLoginFilterëŠ” íŠ¹ì •í•œ URLë¡œ ì™¸ë¶€ì—ì„œ ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•˜ë„ë¡ í•˜ê³ , ë¡œê·¸ì¸ì´ ì„±ê³µí•˜ë©´ í´ë¼ì´ì–¸íŠ¸ê°€ Authorization í—¤ë”ì˜ ê°’ìœ¼ë¡œ ì´ìš©í•  ë°ì´í„°ë¥¼ ì „ì†¡í•  ê²ƒì´ë‹¤. ì˜ˆì œì—ì„œëŠ” <strong>â€˜/api/loginâ€™</strong>ì´ë¼ëŠ” URLì„ ì´ìš©í•´ì„œ ì™¸ë¶€ì˜ í´ë¼ì´ì–¸íŠ¸ê°€ ìì‹ ì˜ ì•„ì´ë””ì™€ íŒ¨ìŠ¤ì›Œë“œë¡œ ë¡œê·¸ì¸í•œë‹¤ê³  ê°€ì •í•œë‹¤.(APIë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ ë³„ë„ì˜ ë©”ë‰´ë¡œ ìŠ¹ì¸ì„ ë°›ëŠ” ê²ƒì´ ì¼ë°˜ì ì´ì§€ë§Œ ì˜ˆì œì—ì„œëŠ” ì¢€ ë” ê·¹ë‹¨ì ìœ¼ë¡œ ì¼ë°˜ ë¡œê·¸ì¸ê³¼ ë™ì¼í•œ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´ ì¼ì • ê¸°ê°„ ë™ì•ˆ APIë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•œë‹¤)</p>

<p><br /></p>

<p>ì‘ì„±í•˜ë ¤ëŠ” ì½”ë“œëŠ” ApiLoginFilterë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ìƒì„±í•œë‹¤. ë‹¤ë§Œ ì´ì „ì˜ ApiCheckFilterì™€ ë‹¬ë¦¬ org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilterë¼ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ ì œê³µí•˜ëŠ” í•„í„°ë¥¼ ì´ìš©í•œë‹¤. security íŒ¨í‚¤ì§€ ë°‘ì— filter íŒ¨í‚¤ì§€ë¥¼ ì°¾ì•„ ApiLoginFilter í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-16-47-33.png" alt="" /></p>

<p><br /></p>

<p><strong>ApiLoginFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.young.club.security.filter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.log4j.Log4j2</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.BadCredentialsException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiLoginFilter</span> <span class="kd">extends</span> <span class="nc">AbstractAuthenticationProcessingFilter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">ApiLoginFilter</span><span class="o">(</span><span class="nc">String</span> <span class="n">defaultFilterProcessesUrl</span><span class="o">){</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">defaultFilterProcessesUrl</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">attemptAuthentication</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-----------------------ApiLoginFilter----------------------"</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"attemptAuthentication"</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"email"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">pw</span><span class="o">=</span><span class="s">"1111"</span><span class="o">;</span>

        <span class="k">if</span><span class="o">(</span><span class="n">email</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="s">"email cannot be null"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><br /></p>

<p>attemptAuthentication()ì—ì„œëŠ” ê°„ë‹¨íˆ emailì´ë¼ëŠ” íŒŒë¼ë¯¸í„°ê°€ ìˆì–´ì•¼ë§Œ ë™ì‘ì´ ê°€ëŠ¥í•˜ë‹¤. ìš°ì„ ì€ ê°„ë‹¨íˆ ë™ì‘ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•œ ìš©ë„ì´ë¯€ë¡œ ë©”ì„œë“œ ë‚´ë¶€ì˜ ë‚´ìš©ì€ ì•ìœ¼ë¡œ ë§ì´ ìˆ˜ì •ë  ê²ƒì´ë‹¤. SecurityConfigì— ApiLoginFilterë¥¼ ì¶”ê°€í•œë‹¤. AbstractAuthenticationProcessingFilterëŠ” ë°˜ë“œì‹œ AuthenticationManagerê°€ í•„ìš”í•˜ë¯€ë¡œ AuthenticationManager()ë¥¼ ì´ìš©í•´ì„œ ì¶”ê°€í•´ ì£¼ì–´ì•¼ í•œë‹¤.</p>

<p><br /></p>

<p><strong>SecurityConfig.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
       <span class="c1">//http.authorizeRequests()ë¡œ ì¸ì¦ì´ í•„ìš”í•œ ìì›ë“¤ì„ ì„¤ì •í•  ìˆ˜ ìˆê³  antMatchers()ëŠ”</span>
        <span class="c1">// '**/*'ì™€ ê°™ì€ ì•¤íŠ¸ ìŠ¤íƒ€ì¼ì˜ íŒ¨í„´ìœ¼ë¡œ ì›í•˜ëŠ” ìì›ì„ ì„ íƒí•  ìˆ˜ ìˆë‹¤.</span>
        <span class="c1">//ë§ˆì§€ë§‰ìœ¼ë¡œ permitAll()ì˜ ê²½ìš°ëŠ” ë§ ê·¸ëŒ€ë¡œ 'ëª¨ë“  ì‚¬ìš©ìì—ê²Œ í—ˆë½'í•œë‹¤ëŠ” ì˜ë¯¸ì´ë¯€ë¡œ</span>
        <span class="c1">//ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìë„ ìµëª…ì˜ ì‚¬ìš©ìë¡œ ê°„ì£¼ë˜ì–´ì„œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ê²Œ ëœë‹¤.</span>
        <span class="c1">//í”„ë¡œì íŠ¸ë¥¼ ì¬ì‹œì‘í•´ì„œ /sample/allì— ì ‘ì†í•˜ë©´ ë³„ë„ì˜ ë¡œê·¸ì¸ ì—†ì´ë„ ì ‘ê·¼ì´ ê°€ëŠ¥í•´ ì§„ë‹¤.</span>
       <span class="c1">// http.authorizeRequests().antMatchers("/sample/all").permitAll()</span>
                                <span class="c1">//ì•„ë˜ì™€ ê°™ì´ ì„¤ì •í•˜ê³  /sample/member'ë¥¼ í˜¸ì¶œí•˜ë©´ Access Denied ëœë‹¤.</span>
      <span class="c1">//                          .antMatchers("/sample/member").hasRole("USER");</span>

        <span class="c1">//ì¸ê°€/ì¸ì¦ì— ë¬¸ì œì‹œ ë¡œê·¸ì¸ í™”ë©´ë©´</span>
       <span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">();</span>
       <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>

       <span class="n">http</span><span class="o">.</span><span class="na">logout</span><span class="o">();</span>


       <span class="c1">//ì´ê²ƒì„ ì¶”ê°€í•´ì¤Œìœ¼ë¡œì¨ êµ¬ê¸€ ë¡œê·¸ì¸ì„ í•˜ë©´ ì´ì „ê³¼ ë‹¬ë¦¬ ë¹ˆ í™”ë©´ë§Œ ë³´ì´ê²Œ ëœë‹¤.</span>
       <span class="n">http</span><span class="o">.</span><span class="na">oauth2Login</span><span class="o">().</span><span class="na">successHandler</span><span class="o">(</span><span class="n">successHandler</span><span class="o">());</span>

       <span class="c1">//remember me ì„¤ì •í•˜ëŠ” ê²ƒì´ë‹¤</span>
        <span class="c1">//rememberMe()ë¥¼ ì ìš©í•  ë•ŒëŠ” ì£¼ë¡œ ì¿ í‚¤ë¥¼ ì–¼ë§ˆë‚˜ ìœ ì§€í•  ê²ƒì¸ì§€ë¥¼ ê°™ì´ ì§€ì •í•œë‹¤. ì´ˆ(second) ë‹¨ìœ„ë¡œ ì„¤ì •í•˜ë¯€ë¡œ ì´ ì½”ë“œëŠ” 7ì¼ê°„ ì¿ í‚¤ê°€ ìœ ì§€ë˜ë„ë¡ ì§€ì •í•˜ì˜€ë‹¤.</span>
       <span class="n">http</span><span class="o">.</span><span class="na">rememberMe</span><span class="o">().</span><span class="na">tokenValiditySeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">7</span><span class="o">).</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">());</span>

       <span class="c1">//ì‹¤ì œ ë¡œê·¸ì¸ ì‹œì— OAuthë¥¼ ì‚¬ìš©í•œ ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•˜ë„ë¡ í•¨</span>
      <span class="c1">// http.oauth2Login();</span>

        <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">apiCheckFilter</span><span class="o">(),</span> <span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">apiLoginFilter</span><span class="o">(),</span> <span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ApiLoginFilter</span> <span class="nf">apiLoginFilter</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ApiLoginFilter</span> <span class="n">apiLoginFilter</span><span class="o">=</span><span class="k">new</span> <span class="nc">ApiLoginFilter</span><span class="o">(</span><span class="s">"/api/login"</span><span class="o">);</span>
        <span class="n">apiLoginFilter</span><span class="o">.</span><span class="na">setAuthenticationManager</span><span class="o">(</span><span class="n">authenticationManager</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">apiLoginFilter</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>ì¶”ê°€í•œ apiLoginFilter()ëŠ” â€˜/api/loginâ€™ ì´ë¼ëŠ” ê²½ë¡œë¡œ ì ‘ê·¼í•  ë•Œ ë™ì‘í•˜ë„ë¡ ì§€ì •í•˜ê³ , UsernamePasswordAuthenticationFilter ì „ì— ë™ì‘í•˜ë„ë¡ ì§€ì •í•˜ì˜€ë‹¤. í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³  â€˜/api/loginâ€™ì„ email íŒŒë¼ë¯¸í„° ì—†ì´ ì „ì†¡í•˜ë©´ ì•„ë˜ ì‚¬ì§„ê³¼ ê°™ì´ 401 ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<link rel="stylesheet" href="https: //www.webnots.com/resources/font-awesome/css/font-awesome.min.css" />

<link rel="stylesheet" href="/assets/css/webnots.css" />

<p><br /></p>

<div class="webnots-information webnots-notification-box">í˜„ì¬ urlë¥¼ ë³´ë©´ í¬íŠ¸ê°€ 8085ë¡œ ë˜ì–´ ìˆëŠ”ë° ì´ëŠ” ë‚´ê°€ ì¼ë¶€ë¡œ application.propertiesì— <span style="color:#85144b; font-weight:bold">server.port=8085</span>ë¥¼ ì¶”ê°€í•œ ê²ƒì´ë‹¤. ìŠ¤í”„ë§ë¶€íŠ¸ ì•±ì„ ì‹¤í–‰í•˜ëŠ”ë° 8080í¬íŠ¸ì— ì˜¤ë¥˜ê°€ ë‚˜ì„œ ì„ì‹œì ìœ¼ë¡œ ë³€ê²½í–ˆë‹¤.</div>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-17-11-06.png" alt="" /></p>

<p><br /></p>

<p>ìœ„ ì‚¬ì§„ì€ ì´ë©”ì¼ì´ ì—†ì–´ì„œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ì´ë‹¤.</p>

<p><br /></p>

<p>íŠ¹ì •í•œ APIë¥´ë¥´ í˜¸ì¶œí•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” ë‹¤ë¥¸ ì„œë²„ë‚˜ Applicationìœ¼ë¡œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ì¿ í‚¤ë‚˜ ì„¸ì…˜ì„ í™œìš©í•  ìˆ˜ ì—†ë‹¤. ì´ëŸ¬í•œ ì œì•½ ë•Œë¬¸ì— APIë¥¼ í˜¸ì¶œí•˜ëŠ” ê²½ìš°ì—ëŠ” Requestë¥¼ ì „ì†¡í•  ë•Œ Http í—¤ë” ë©”ì‹œì§€ì— íŠ¹ë³„í•œ ê°’ì„ ì§€ì •í•´ì„œ ì „ì†¡í•œë‹¤.</p>

<p><br /></p>

<p>Authorization í—¤ë”ëŠ” ì´ëŸ¬í•œ ìš©ë„ë¡œ ì‚¬ìš©í•œë‹¤. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ì†¡í•œ Reqeustì— í¬í•¨ëœ Authorization í—¤ë”ì˜ ê°’ì„ íŒŒì•…í•´ì„œ ì‚¬ìš©ìê°€ ì •ìƒì ì¸ ìš”ì²­ì¸ì§€ë¥¼ ì•Œì•„ë‚´ëŠ” ê²ƒì´ë‹¤. ApiCheckFilterì—ì„œ Authorization í—¤ë”ë¥¼ ì¶”ì¶œí•˜ê³  í—¤ë”ì˜ ê°’ì´ â€˜12345678â€™ì¸ ê²½ìš°ì—ëŠ” ì¸ì¦ì„ í•œë‹¤ê³  ê°€ì •í•´ ë³´ì. ë§Œì¼ í—¤ë”ì˜ ê°’ì´ ì •í™•í•˜ë‹¤ë©´ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì§„í–‰í•˜ê³  ê·¸ë ‡ì§€ ëª»í•˜ë‹¤ë©´ ë‹¤ë¥¸ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•´ì•¼ í•œë‹¤. ê¸°ì¡´ì˜ checkAuthHeader() ë©”ì„œë“œë¥¼ ì¶”ê°€í•´ì„œ ì´ëŸ¬í•œ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.</p>

<p><br /></p>

<p><strong>ApiCheckFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"REQUESTURI: "</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">());</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">antPathMatcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">pattern</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">()));</span>
        <span class="k">if</span><span class="o">(</span><span class="n">antPathMatcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">pattern</span><span class="o">,</span><span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>


            <span class="c1">//checkAuthHeader()ì—ì„œ í—¤ë”ì˜ ê°’ì„ ì¸ì¦í•œë‹¤.</span>
            <span class="kt">boolean</span> <span class="n">checkHeader</span><span class="o">=</span><span class="n">checkAuthHeader</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

            <span class="k">if</span><span class="o">(</span><span class="n">checkHeader</span><span class="o">){</span>
                <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span><span class="n">response</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>


        <span class="c1">//ë‹¤ìŒ í•„í„°ì˜ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ëŠ” ì—­í• ì„ ìœ„í•´ì„œ í•„ìš”í•˜ë‹¤</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkAuthHeader</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">){</span>
        <span class="kt">boolean</span> <span class="n">checkResult</span><span class="o">=</span><span class="kc">false</span><span class="o">;</span>


        <span class="c1">//í—¤ë”ì˜ ê°’ì„ ì¸ì¦í•˜ê¸° ìœ„í•´ì„œ Authorzation í—¤ë”ë¥¼ ì¶”ì¶œí•œë‹¤.</span>
        <span class="nc">String</span> <span class="n">authHeader</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">);</span>

        <span class="c1">//authHeader ë¬¸ìì—´ ë³€ìˆ˜ê°€ ë¬¸ìì—´ì„ í¬í•¨í•˜ëŠ”ì§€ ì²´í¬í•œë‹¤.</span>
        <span class="k">if</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">authHeader</span><span class="o">)){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Authorization exist: "</span><span class="o">+</span><span class="n">authHeader</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">authHeader</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"12345678"</span><span class="o">)){</span>
                <span class="c1">//"12345678"ì„ ë‹´ê³  ìˆìœ¼ë©´ trueë¥¼ ë‹´ëŠ”ë‹¤.</span>
                <span class="n">checkResult</span><span class="o">=</span><span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">checkResult</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>checkAuthHeader()ëŠ” â€˜Authorizationâ€™ì´ë¼ëŠ” í—¤ë”ì˜ ê°’ì„ í™•ì¸í•˜ê³  boolean íƒ€ì…ì˜ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤. ì´ë¥¼ ì´ìš©í•´ì„œ doFilterInternal()ì—ì„œ ë‹¤ìŒ í•„í„°ë¡œ ì§„í–‰í•  ê²ƒì¸ì§€ë¥¼ ê²°ì •í•œë‹¤. í…ŒìŠ¤íŠ¸ ë„êµ¬ë¡œ â€˜/notes/2â€™ì™€ ê°™ì´ ê¸°ì¡´ì— í…ŒìŠ¤íŠ¸í–ˆë˜ URLì„ í™•ì¸í•œë‹¤.</p>

<p>Requestë¥¼ ì „ì†¡í•˜ê¸° ì „ì— â€˜Add New Headerâ€™ë¥¼ ì„ íƒí•´ì„œ â€˜Authorizationâ€™ í—¤ë” ê°’ì„ ì¡°ì •í•œë‹¤.</p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-17-35-25.png" alt="" /></p>

<p><br /></p>

<p>ì´ì œ Send ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•œë‹¤.</p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-17-35-11.png" alt="" /></p>

<p><br /></p>

<p>ìœ„ì˜ ì½”ë“œëŠ” Authorization í—¤ë”ì˜ ê°’ì´ ì •ìƒì¼ ë•Œë„ ë™ì‘í•˜ì§€ë§Œ ë¶ˆí–‰íˆë„ Authorization í—¤ë”ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ” ì •ìƒì´ë¼ëŠ” ë©”ì‹œì§€ê°€ ì „ì†¡ëœë‹¤. í…ŒìŠ¤íŠ¸ ë„êµ¬ì—ì„œ Authorization í—¤ë”ë¥¼ ì‚­ì œí•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-17-36-47.png" alt="" /></p>

<p><br /></p>

<p>ì‹¤í–‰ ê²°ê³¼ë¥¼ ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ê²°ê³¼ ë°ì´í„°ëŠ” ì—†ì–´ë„ â€˜200â€™ ë©”ì‹œì§€ê°€ ë°œí–‰ëœë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-17-41-17.png" alt="" /></p>

<p><br /></p>

<p>ìœ„ì— ì‚¬ì§„ìœ¼ë¡œ ì˜ ì•ˆ ë³´ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ í™•ëŒ€í•´ì„œ ë³´ì—¬ì£¼ê² ë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-17-41-40.png" alt="" /></p>

<p><br /></p>

<p>ì´ê²ƒì€ ApiCheckFilterê°€ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ì‚¬ìš©í•˜ëŠ” ì¿ í‚¤ë‚˜ ì„¸ì…˜ì„ ì´ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ë¬¸ì œì´ë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ì •ìƒì ì¸ ì¸ì¦ì„ ì²˜ë¦¬í•˜ë„ë¡ AuthenticationManagerë¥¼ ì´ìš©í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ApiCheckFilterì—ì„œ ê°„ë‹¨í•˜ê²Œ JSON í¬ë§·ì˜ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì˜ˆì œì—ì„œëŠ” ê°„ë‹¨íˆ JSON ë°ì´í„°ë¥¼ ì „ì†¡í•œë‹¤.</p>

<p><br /></p>

<p><strong>ApiCheckFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"REQUESTURI: "</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">());</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">antPathMatcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">pattern</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">()));</span>
        <span class="k">if</span><span class="o">(</span><span class="n">antPathMatcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">pattern</span><span class="o">,</span><span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"APICheckerFilter.................................."</span><span class="o">);</span>


            <span class="c1">//checkAuthHeader()ì—ì„œ í—¤ë”ì˜ ê°’ì„ ì¸ì¦í•œë‹¤.</span>
            <span class="kt">boolean</span> <span class="n">checkHeader</span><span class="o">=</span><span class="n">checkAuthHeader</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

            <span class="k">if</span><span class="o">(</span><span class="n">checkHeader</span><span class="o">){</span>
                <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span><span class="n">response</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="c1">//</span>
                <span class="c1">//403ì—ëŸ¬ë¥¼ ë„ìš´ë‹¤.</span>
                <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_FORBIDDEN</span><span class="o">);</span>
                <span class="c1">//json ë¦¬í„´ ë° í•œê¸€ê¹¨ì§ ìˆ˜ì •.</span>
                <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json;charset=utf-8"</span><span class="o">);</span>
                <span class="nc">JSONObject</span> <span class="n">json</span><span class="o">=</span><span class="k">new</span> <span class="nc">JSONObject</span><span class="o">();</span>
                <span class="nc">String</span> <span class="n">message</span><span class="o">=</span><span class="s">"FAIL CHECK API TOKEN"</span><span class="o">;</span>
                <span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"code"</span><span class="o">,</span><span class="s">"403"</span><span class="o">);</span>
                <span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span><span class="n">message</span><span class="o">);</span>

                <span class="nc">PrintWriter</span> <span class="n">out</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
                <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>


        <span class="c1">//ë‹¤ìŒ í•„í„°ì˜ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ëŠ” ì—­í• ì„ ìœ„í•´ì„œ í•„ìš”í•˜ë‹¤</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>ë³€ê²½ëœ ë‚´ìš©ì€ checkHeader()ê°€ falseë¥¼ ë°˜í™˜í•˜ëŠ” ê²½ìš°ì— net.minidev.json.JSONObject.JSONObjectë¥¼ ì´ìš©í•´ì„œ ê°„ë‹¨í•œ JSON ë°ì´í„°ì™€ 403 ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë§Œë“¤ì–´ì„œ ì „ì†¡í•œë‹¤. ìœ„ì˜ ì½”ë“œë¥¼ ë°˜ì˜í•˜ë©´ Authorization í—¤ë”ê°€ ì—†ê±°ë‚˜ ë‹¤ë¥¸ ê°’ì„ ì „ì†¡í•˜ëŠ” ê²½ìš° ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ê°€ ìƒê¸°ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-18-05-51.png" alt="" /></p>

<p><br /></p>

<p>Authorization í—¤ë”ì— ë”°ë¼ì„œ ë‹¤ë¥´ê²Œ ë™ì‘í•˜ëŠ” ì½”ë“œê°€ ì™„ì„±ë˜ì—ˆë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì‘ì—…ì„ ì²˜ë¦¬í•´ì•¼ í•œë‹¤.</p>

<p><br /></p>

<div class="webnots-success webnots-notification-box">ì™¸ë¶€ì—ì„œ ì¸ì¦í•  ìˆ˜ ìˆëŠ” ì¸ì¦ì²˜ë¦¬</div>
<div class="webnots-success webnots-notification-box">ApiCheckFilterê°€ Authorization í—¤ë”ì˜ ê°’ì„ ë°œí–‰í•˜ê¸°</div>

<p><br /></p>

<p>ApiLoginFilterê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ê¸° ìœ„í•´ì„œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ AuthticationManagerë¥¼ ì‚¬ìš©í•´ì„œ ë™ì‘í•˜ë„ë¡ ìˆ˜ì •í•´ì•¼ í•œë‹¤. AuthenticationManagerëŠ” authenticate() ë©”ì„œë“œë¥¼ ê°€ì§€ê³  ìˆëŠ”ë° íŠ¹ì´í•˜ê²Œë„ íŒŒë¼ë¯¸í„°ì™€ ë¦¬í„´ íƒ€ì…ì´ ë™ì¼í•˜ê²Œ Authentication íƒ€ì…ì´ë‹¤.</p>

<p><br /></p>

<p>íŒŒë¼ë¯¸í„°ë¡œ ì „ì†¡í•˜ëŠ” Authentication íƒ€ì…ì˜ ê°ì²´ë¡œëŠ” â€˜xxxTokenâ€™ì´ë¼ëŠ” ê²ƒì„ ì‚¬ìš©í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ UsernamePasswordAuthenticationFilter í´ë˜ìŠ¤ëŠ” org.springframework.security.authentication.UsernamePasswordAuthenticationTokenì´ë¼ëŠ” ê°ì²´ë¥¼ ì‚¬ìš©í•œë‹¤. ì§ì ‘ Authentication íƒ€ì…ì˜ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•  ìˆ˜ë„ ìˆì§€ë§Œ ì˜ˆì œì—ì„œëŠ” ìµœëŒ€í•œ ê°„ë‹¨íˆ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” UsernamePasswordAuthenticationTokenì„ ì‚¬ìš©í•´ì„œ ì¸ì¦ì„ ì§„í–‰í•œë‹¤.</p>

<p><br /></p>

<p><strong>ApiLoginFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">attemptAuthentication</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-----------------------ApiLoginFilter----------------------"</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"attemptAuthentication"</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"email"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">pw</span><span class="o">=</span><span class="s">"1111"</span><span class="o">;</span>

        <span class="nc">UsernamePasswordAuthenticationToken</span> <span class="n">authToken</span><span class="o">=</span><span class="k">new</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">email</span><span class="o">,</span><span class="n">pw</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">email</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BadCredentialsException</span><span class="o">(</span><span class="s">"email cannot be null"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>ë³€ê²½ëœ ë‚´ìš©ì€ email, pwë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì„œ ì‹¤ì œ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ë‹¤. ë¸Œë¼ìš°ì €ë¥¼ ì´ìš©í•´ì„œ â€˜/api/login?email=xxx&amp;pw=xxxâ€™ì™€ ê°™ì´ ì‹¤ì œ ì‚¬ìš©ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ì„ ì‹œë„í•´ ë³´ë©´ â€˜/â€™ë¡œ ì´ë™í•˜ê¸°ëŠ” í•˜ì§€ë§Œ ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<p><br /></p>

<p>ë¡œê·¸ì¸ í›„ì— í™”ë©´ì—ëŠ” â€˜/â€™ë¡œ ì´ë™í–ˆì§€ë§Œ â€˜/sample/memberâ€™ ë“±ì˜ URLì„ í˜¸ì¶œí•˜ë©´ ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-18-17-49.png" alt="" /></p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-18-18-04.png" alt="" /></p>

<p><br /></p>

<link href="http://fonts.googleapis.com/earlyaccess/hanna.css" rel="stylesheet" />

<div style="background: #eee;
  box-shadow: 0 8px 8px -4px lightblue; font-family: 'Hanna', sans-serif;; padding: 40px;">

ë‹¹ì—°í•œ ì´ì•¼ê¸°ì§€ë§Œ ì‹¤ì œ ìœ„ì™€ ê°™ì´ ë¡œê·¸ì¸ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì€ POST ë°©ì‹ìœ¼ë¡œ í•˜ê³ , ê°€ëŠ¥í•˜ë©´ ì „ë‹¬ë˜ëŠ” íŒŒë¼ë¯¸í„°ë“¤ ì—­ì‹œ ì•”í˜¸í™”ë¥¼ í•´ ì£¼ì–´ì•¼ í•œë‹¤. ì˜ˆì œì—ì„œëŠ” ë¹¨ë¦¬ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆê²Œ GET ë°©ì‹ê³¼ í‰ë¬¸ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ì˜€ë‹¤.</div>

<p><br /></p>

<p>ApiLoginFilterë¡œ ì§ì ‘ ì¸ì¦ì²˜ë¦¬ë¥¼ í–ˆë‹¤ë©´ ë‚¨ì€ ì‘ì—…ì€ ì¸ì¦ í›„ ì„±ê³µ í˜¹ì€ ì‹¤íŒ¨ì— ë”°ë¥¸ ì²˜ë¦¬ì´ë‹¤. ì´ëŸ¬í•œ ì²˜ë¦¬ëŠ” ë©”ì„œë“œë¥¼ overrideí•´ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ ë³„ë„ì˜ í´ë˜ìŠ¤ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì˜ˆì œì—ì„œëŠ” 2ê°€ì§€ ëª¨ë‘ë¥¼ ì†Œê°œí•˜ë ¤ í•œë‹¤.</p>

<p><br /></p>

<p>ApiLoginFilterì—ì„œ ì¸ì¦ì— ì‹¤íŒ¨í•˜ëŠ” ê²½ìš° API ì„œë²„ëŠ” ì¼ë°˜ í™”ë©´ì´ ì•„ë‹ˆë¼ JSON ê²°ê³¼ê°€ ì „ì†¡ë˜ë„ë¡ ìˆ˜ì •í•´ì•¼ í•˜ê³  ì„±ê³µí•˜ëŠ” ê²½ìš°ì—ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ê´€í•  ì¸ì¦ í† í°ì´ ì „ì†¡ë˜ì–´ì•¼ í•œë‹¤. AbstractAuthenticationProcessingFilterì—ëŠ” setAuthenticationFailureHandler()ë¥¼ ì´ìš©í•´ì„œ ì¸ì¦ì— ì‹¤íŒ¨í–ˆì„ ê²½ìš° ì²˜ë¦¬ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤. security íŒ¨í‚¤ì§€ì˜ handler íŒ¨í‚¤ì§€ ë‚´ ApiLoginFailHandler í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-18-23-56.png" alt="" /></p>

<p><br /></p>

<p><strong>ApiLoginFailHandler.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.young.club.security.handler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.log4j.Log4j2</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.minidev.json.JSONObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AuthenticationFailureHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.PrintWriter</span><span class="o">;</span>

<span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiLoginFailHandler</span> <span class="kd">implements</span> <span class="nc">AuthenticationFailureHandler</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationFailure</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">AuthenticationException</span> <span class="n">exception</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"login fail handler............."</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">exception</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_UNAUTHORIZED</span><span class="o">);</span>
        <span class="c1">//jsonë¦¬í„´</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json;charset=utf-8"</span><span class="o">);</span>
        <span class="nc">JSONObject</span> <span class="n">json</span><span class="o">=</span><span class="k">new</span> <span class="nc">JSONObject</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">message</span><span class="o">=</span><span class="n">exception</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
        <span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"code"</span><span class="o">,</span><span class="s">"401"</span><span class="o">);</span>
        <span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span><span class="n">message</span><span class="o">);</span>

        <span class="nc">PrintWriter</span> <span class="n">out</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><br /></p>

<p>ApiLoginFailHandlerëŠ” AuthenticationFailureHandler ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤ë¡œ ì˜¤ì§ ì¸ì¦ì— ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ì— ì²˜ë¦¬ë¥¼ ì „ë‹´í•˜ë„ë¡ êµ¬ì„±í•œë‹¤. ì¸ì¦ì— ì‹¤íŒ¨í•˜ë©´ â€˜401â€™ ìƒíƒœ ì½”ë“œë¥¼ ë°˜í™˜í•˜ë„ë¡ í•œë‹¤. SecurityConfig í´ë˜ìŠ¤ì—ëŠ” ApiLoginFilterì˜ setAuthenticationFailureHandler()ë¥¼ ì ìš©í•´ ì£¼ì–´ì•¼ í•œë‹¤.</p>

<p><br /></p>

<p><strong>SecurityConfig.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ApiLoginFilter</span> <span class="nf">apiLoginFilter</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ApiLoginFilter</span> <span class="n">apiLoginFilter</span><span class="o">=</span><span class="k">new</span> <span class="nc">ApiLoginFilter</span><span class="o">(</span><span class="s">"/api/login"</span><span class="o">);</span>
        <span class="n">apiLoginFilter</span><span class="o">.</span><span class="na">setAuthenticationManager</span><span class="o">(</span><span class="n">authenticationManager</span><span class="o">());</span>

        <span class="n">apiLoginFilter</span><span class="o">.</span><span class="na">setAuthenticationFailureHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApiLoginFailHandler</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">apiLoginFilter</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>í”„ë¡œì íŠ¸ë¥¼ ì¬ì‹œì‘í•˜ê³  ì¸ì¦ì´ ë¶ˆê°€ëŠ¥í•œ ì •ë³´ë¥¼ ì „ì†¡í•˜ë©´ â€˜401â€™ ìƒíƒœ ì½”ë“œì™€ í•¨ê»˜ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ì „ì†¡ëœë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-18-28-18.png" alt="" /></p>

<p><br /></p>

<p>ì¸ì¦ì˜ ì‹¤íŒ¨ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ì¸ì¦ì˜ ì„±ê³µ ë˜í•œ ë³„ë„ì˜ í´ë˜ìŠ¤ë¡œ ì‘ì„±í•´ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆê¸´ í•˜ì§€ë§Œ AbstractAuthenticationProcessingFilter í´ë˜ìŠ¤ì—ëŠ” successfulAuthentication()ë¼ëŠ” ë©”ì„œë“œë¥¼ override í•´ì„œ êµ¬í˜„ì´ ê°€ëŠ¥í•˜ë‹¤.</p>

<p><br /></p>

<p><strong>ApiLoginFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">successfulAuthentication</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">,</span> <span class="nc">Authentication</span> <span class="n">authResult</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"---------------------ApiLoginFilter--------------"</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"successfulAuthentication: "</span><span class="o">+</span><span class="n">authResult</span><span class="o">);</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">authResult</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>successfulAuthentication()ì˜ ë§ˆì§€ë§‰ íŒŒë¼ë¯¸í„°ëŠ” ì„±ê³µí•œ ì‚¬ìš©ìì˜ ì¸ì¦ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆëŠ” Authentication ê°ì²´ì´ë‹¤. ì´ë¥¼ í†µí•´ì„œ ì¸ì¦ì— ì„±ê³µí•œ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë¡œê·¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ â€˜/api/login?email=user90@zerock.org@pw=1111â€™ê³¼ ê°™ì´ ì •ìƒì ì¸ ê³„ì • ì •ë³´ë¥¼ ì´ìš©í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ë¡œê·¸ê°€ ê¸°ë¡ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-11-18-32-25.png" alt="" /></p>

<p><br /></p>

<p>ì¸ì¦ì— ì„±ê³µí•œ í›„ì—ëŠ” ì‚¬ìš©ìê°€ â€˜/notes/xxâ€™ì™€ ê°™ì€ apië¥¼ í˜¸ì¶œí•  ë•Œ ì‚¬ìš©í•  ì ì ˆí•œ ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ì„œ ì „ì†¡í•´ ì£¼ì–´ì•¼ í•œë‹¤. ì—¬ê¸°ì„œ JWT(JSON Web Token)ë¥¼ ì´ìš©í•  ê²ƒì´ë‹¤. ì´ëŠ¦ã…‡ì´ ì„±ê³µí•œ ì‚¬ìš©ìì—ê²ŒëŠ” íŠ¹ìˆ˜í•œ ë¬¸ìì—´(JWT)ì„ ì „ì†¡í•´ ì£¼ê³ , APIë¥¼ í˜¸ì¶œí•  ë•ŒëŠ” ì´ ë¬¸ìì—´ì„ ì½ì–´ì„œ í•´ë‹¹ Requestê°€ ì •ìƒì ì¸ ìš”ì²­ì¸ì§€ë¥¼ í™•ì¸í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©í•  ê²ƒì´ë‹¤.</p>

<p>JWTë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤.</p>

<p><br /></p>

<p><strong>build.gradle</strong></p>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">implementation</span> <span class="nl">group:</span> <span class="s1">'io.jsonwebtoken'</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">'jjwt'</span><span class="o">,</span> <span class="nl">version:</span> <span class="s1">'0.9.1'</span>
</code></pre></div></div>

<p><br /></p>

<p>JWTë¥¼ í˜„ì¬ í”„ë¡œì íŠ¸ì—ì„œëŠ” 1) ì¸ì¦ì— ì„±ê³µí–ˆì„ ë•Œ JWT ë¬¸ìì—´ì„ ë§Œë“¤ì–´ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡í•˜ëŠ” ê²ƒê³¼, 2) í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ í† í°ì˜ ê°’ì„ ê²€ì¦í•˜ëŠ” ê²½ìš°ì— ì‚¬ìš©ëœë‹¤. ì˜ˆì œ í”„ë¡œì íŠ¸ ë‚´ì—ëŠ” security íŒ¨í‚¤ì§€ ë‚´ì— utilì´ë¼ëŠ” íŒ¨í‚¤ì§€ë¥¼ êµ¬ì„±í•˜ê³  JWTUtilì´ë¼ëŠ” í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-12-17-35-18.png" alt="" /></p>

<p><br /></p>

<p><strong>JWTUitl.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.young.club.security.util</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.jsonwebtoken.Jwts</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.jsonwebtoken.SignatureAlgorithm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.jsonwebtoken.impl.DefaultClaims</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.jsonwebtoken.impl.DefaultJws</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.log4j.Log4j2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.ZonedDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JWTUtil</span> <span class="o">{</span>
    <span class="c1">//ì´ í‚¤ë¥¼ ì´ìš©í•´ì„œ Signatureë¥¼ ìƒì„±í•œë‹¤.</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">secretKey</span><span class="o">=</span><span class="s">"zerock12345678"</span><span class="o">;</span>

    <span class="c1">//1month</span>
    <span class="c1">//JWT ë¬¸ìì—´ ìì²´ë¥¼ ì•Œë©´ ëˆ„êµ¬ë“  APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ë¬¸ì œê°€ ìƒê¸°ë¯€ë¡œ ë§Œë£Œ ê¸°ê°„(expire) ê°’ì„ ì„¤ì •í•œë‹¤</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">expire</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="o">;</span>

    <span class="c1">//JWT í† í°ì„ ìƒì„±í•˜ëŠ” ì—­í• ì„ í•œë‹¤.</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">generateToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="k">return</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="c1">//ì–¸ì œ ë°œí–‰ë˜ëŠ”ì§€ ì„¸íŒ…í•œë‹¤. ì´ê²ƒì„ ì‹¤í–‰í•˜ëŠ” í˜„ì¬ ì‹œê°„ê³¼ ë‚ ì§œë¡œ ì„¤ì •í•¨</span>
                <span class="o">.</span><span class="na">setIssuedAt</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">())</span>

                <span class="c1">//ìœ„ì— ì„¤ì •í•œ ìœ íš¨ê¸°ê°„ì„ ì„¤ì •í•œë‹¤.</span>
                <span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="nc">Date</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">ZonedDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusMinutes</span><span class="o">(</span><span class="n">expire</span><span class="o">).</span><span class="na">toInstant</span><span class="o">()))</span>
                <span class="c1">//ì‚¬ìš©ìì˜ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì–´ì„œ ë‚˜ì¤‘ì— ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•œë‹¤.</span>
                <span class="o">.</span><span class="na">claim</span><span class="o">(</span><span class="s">"sub"</span><span class="o">,</span> <span class="n">content</span><span class="o">)</span>
                <span class="c1">//getBytesëŠ” secretKey ë¬¸ìì—´ì„ ë°”ì´íŠ¸ë¡œ ì¸ì½”ë”©í•œë‹¤.</span>
                <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="nc">SignatureAlgorithm</span><span class="o">.</span><span class="na">ES256</span><span class="o">,</span> <span class="n">secretKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">))</span>
                <span class="c1">//JWTë¥¼ ë¹Œë“œí•˜ê³  ì‹œë¦¬ì–¼ë¼ì´ì¦ˆ í•œë‹¤.</span>
                <span class="o">.</span><span class="na">compact</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">//ì¸ì½”ë”©ëœ ë¬¸ìì—´ì—ì„œ ì›í•˜ëŠ” ê°’ì„ ì¶”ì¶œí•˜ëŠ” ìš©ë„ì´ë‹¤.</span>
    <span class="c1">//ì—¬ê¸°ì„œëŠ” JWT ë¬¸ìì—´ì„ ê²€ì¦í•˜ëŠ” ì—­í• ì„ í•œë‹¤. JWTê°€ ë§Œë£Œê¸°ê°„ì´ ì§€ë‚œ ê²ƒì´ë¼ë©´ ì´ ê³¼ì •ì—ì„œ Exceptionì´ ë°œìƒí•œë‹¤.</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">validateAndExtract</span><span class="o">(</span><span class="nc">String</span> <span class="n">tokenStr</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">String</span> <span class="n">contentValue</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="c1">//parseClaimsJwsëŠ” ì‹œë¦¬ì–¼ë¼ì´ì¦ˆëœ íŠ¹ì • JWS ë¬¸ìì—´ì„ íŒŒì‹±í•´ì„œ JWS ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤</span>
            <span class="nc">DefaultJws</span> <span class="n">defaultJws</span><span class="o">=(</span><span class="nc">DefaultJws</span><span class="o">)</span><span class="nc">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">().</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">secretKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">)).</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">tokenStr</span><span class="o">);</span>

            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">defaultJws</span><span class="o">);</span>

            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">defaultJws</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>

            <span class="c1">//getBody()ëŠ” JWT ë°”ë””ë¥¼ ë¦¬í„´í•œë‹¤(ë¬¸ìì—´ì¼ ìˆ˜ë„ ìˆê³  Claim ê°ì²´ì¼ ìˆ˜ë„ ìˆë‹¤.)</span>
            <span class="nc">DefaultClaims</span> <span class="n">claims</span><span class="o">=(</span><span class="nc">DefaultClaims</span><span class="o">)</span><span class="n">defaultJws</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>

            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"----------------"</span><span class="o">);</span>

            <span class="c1">//Returns the JWT sub (subject) value or null if not present.</span>
            <span class="n">contentValue</span><span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="n">contentValue</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">contentValue</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><br /></p>

<p>ì´ì œ testë¥¼ í•´ë³¸ë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-12-17-53-46.png" alt="" /></p>

<p><br /></p>

<p><strong>JWTTests.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.young.club.security</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.BeforeEach</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.young.club.security.util.JWTUtil</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JWTTests</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">JWTUtil</span> <span class="n">jwtUtil</span><span class="o">;</span>

    <span class="c1">//@BeforeEachëŠ” @Test ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ ë©”ì„œë“œê°€ í˜¸ì¶œë˜ê¸° ì „ì— ë¨¼ì € í˜¸ì¶œë˜ì–´ì•¼ í•œë‹¤ëŠ” ì˜ë¯¸ë¥¼ ì§€ë‹Œë‹¤.</span>
    <span class="nd">@BeforeEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBefore</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"testBefore........."</span><span class="o">);</span>
        <span class="n">jwtUtil</span><span class="o">=</span><span class="k">new</span> <span class="nc">JWTUtil</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testEncode</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">String</span> <span class="n">email</span><span class="o">=</span><span class="s">"user95@zerock.org"</span><span class="o">;</span>

        <span class="nc">String</span> <span class="n">str</span><span class="o">=</span><span class="n">jwtUtil</span><span class="o">.</span><span class="na">generateToken</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><br /></p>

<p>ê¸°ì¡´ì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œì™€ëŠ” ë‹¬ë¦¬ JWTTests í´ë˜ìŠ¤ëŠ” ìŠ¤í”„ë§ì„ ì´ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì•„ë‹ˆë¯€ë¡œ ë‚´ë¶€ì—ì„œ ì§ì ‘ JWTUtil ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•  í•„ìš”ê°€ ìˆë‹¤. testEncode()ë¥¼ ì´ìš©í•´ì„œ ë§Œë“¤ì–´ì§€ëŠ” JWT ë¬¸ìì—´ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-12-18-10-34.png" alt="" /></p>

<p><br /></p>

<p>ì´ì œ JWTUtilì˜ generateToke()ì— ëŒ€í•œ ê²€ì¦ì„ í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œë„ í™•ì¸í•´ ë³¼ í•„ìš”ê°€ ìˆë‹¤.</p>

<p><br /></p>

<p><strong>JWTTests.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testValidate</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">String</span> <span class="n">email</span><span class="o">=</span><span class="s">"user95@zerock.org"</span><span class="o">;</span>

        <span class="nc">String</span> <span class="n">str</span><span class="o">=</span><span class="n">jwtUtil</span><span class="o">.</span><span class="na">generateToken</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>

        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">resultEmail</span><span class="o">=</span><span class="n">jwtUtil</span><span class="o">.</span><span class="na">validateAndExtract</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">resultEmail</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>ìœ„ì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ ê²°ê³¼ëŠ” email ë³€ìˆ˜ì˜ ê°’ê³¼ ë™ì¼í•œ ë¬¸ìì—´ì´ ì¶œë ¥ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-12-18-14-08.png" alt="" /></p>

<p><br /></p>

<p>JWTì— ëŒ€í•œ ìƒì„±ê³¼ ê²€ì¦ì— ë¬¸ì œê°€ ì—†ë‹¤ë©´ ìµœì¢…ì ìœ¼ë¡œ ApiLoginFilter/ApiCheckFilterì— ì ìš©í•´ì•¼ í•œë‹¤.</p>

<p>ApiLoginFilterì—ì„œëŠ” ì„±ê³µí•œ í›„ì— JWT ë¬¸ìì—´ì„ ì‚¬ìš©ìì—ê²Œ ì „ì†¡í•œë‹¤.</p>

<p><br /></p>

<p><strong>ApiLoginFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiLoginFilter</span> <span class="kd">extends</span> <span class="nc">AbstractAuthenticationProcessingFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">JWTUtil</span> <span class="n">jwtUtil</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ApiLoginFilter</span><span class="o">(</span><span class="nc">String</span> <span class="n">defaultFilterProcessesUrl</span><span class="o">){</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">defaultFilterProcessesUrl</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jwtUtil</span><span class="o">=</span><span class="n">jwtUtil</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>ì£¼ì… ë°›ì€ JWTUtilì„ ì´ìš©í•´ì„œ successfulAuthentication() ë‚´ì—ì„œ ë¬¸ìì—´ì„ ë°œí–‰í•´ ì¤€ë‹¤.</p>

<p><br /></p>

<p><strong>ApiLoginFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiLoginFilter</span> <span class="kd">extends</span> <span class="nc">AbstractAuthenticationProcessingFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">JWTUtil</span> <span class="n">jwtUtil</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ApiLoginFilter</span><span class="o">(</span><span class="nc">String</span> <span class="n">defaultFilterProcessesUrl</span><span class="o">,</span> <span class="nc">JWTUtil</span> <span class="n">jwtUtil</span><span class="o">)</span> <span class="o">{</span>

        <span class="kd">super</span><span class="o">(</span><span class="n">defaultFilterProcessesUrl</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jwtUtil</span> <span class="o">=</span> <span class="n">jwtUtil</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">attemptAuthentication</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-----------------ApiLoginFilter---------------------"</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"attemptAuthentication"</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"email"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"pw"</span><span class="o">);</span>

        <span class="nc">UsernamePasswordAuthenticationToken</span> <span class="n">authToken</span> <span class="o">=</span>
                <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">email</span><span class="o">,</span> <span class="n">pw</span><span class="o">);</span>

        <span class="k">return</span> <span class="nf">getAuthenticationManager</span><span class="o">().</span><span class="na">authenticate</span><span class="o">(</span><span class="n">authToken</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">successfulAuthentication</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">,</span> <span class="nc">Authentication</span> <span class="n">authResult</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-----------------ApiLoginFilter---------------------"</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"successfulAuthentication: "</span> <span class="o">+</span> <span class="n">authResult</span><span class="o">);</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">authResult</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">());</span>

        <span class="c1">//email address</span>
        <span class="nc">String</span> <span class="n">email</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ClubAuthMemberDTO</span><span class="o">)</span><span class="n">authResult</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">()).</span><span class="na">getUsername</span><span class="o">();</span>

        <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">jwtUtil</span><span class="o">.</span><span class="na">generateToken</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>

            <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/plain"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">token</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>

            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>


        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><br /></p>

<p>SecurityConfig í´ë˜ìŠ¤ì—ì„œëŠ” ApiLoginFilterë¥¼ ìƒì„±í•˜ëŠ” ë¶€ë¶„ì— JWTUitlì„ ìƒì„±ìì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì •í•´ ì¤€ë‹¤.</p>

<p><br /></p>

<p><strong>SecurityConfig.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ApiLoginFilter</span> <span class="nf">apiLoginFilter</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>

        <span class="nc">ApiLoginFilter</span> <span class="n">apiLoginFilter</span> <span class="o">=</span>  <span class="k">new</span> <span class="nc">ApiLoginFilter</span><span class="o">(</span><span class="s">"/api/login"</span><span class="o">,</span> <span class="n">jwtUtil</span><span class="o">());</span>
        <span class="n">apiLoginFilter</span><span class="o">.</span><span class="na">setAuthenticationManager</span><span class="o">(</span><span class="n">authenticationManager</span><span class="o">());</span>

        <span class="n">apiLoginFilter</span>
                <span class="o">.</span><span class="na">setAuthenticationFailureHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApiLoginFailHandler</span><span class="o">());</span>

        <span class="k">return</span> <span class="n">apiLoginFilter</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JWTUtil</span> <span class="nf">jwtUtil</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JWTUtil</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>APICheckerFilterëŠ” â€˜Authorizationâ€™ í—¤ë” ë©”ì‹œì§€ë¥¼ í†µí•´ì„œ JWTë¥¼ í™•ì¸í•˜ë„ë¡ ìˆ˜ì •í•´ì•¼ í•œë‹¤. ApiCheckFilterëŠ” JWTUitlì´ í•„ìš”í•˜ë¯€ë¡œ ìƒì„±ìë¥¼ í†µí•´ì„œ ì£¼ì…í•˜ë„ë¡ ìˆ˜ì •í•œë‹¤.</p>

<p><br /></p>

<p><strong>ApiCheckFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiCheckFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">AntPathMatcher</span> <span class="n">antPathMatcher</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">pattern</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JWTUtil</span> <span class="n">jwtUtil</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ApiCheckFilter</span><span class="o">(</span><span class="nc">String</span> <span class="n">pattern</span><span class="o">,</span><span class="nc">JWTUtil</span> <span class="n">jwtUtil</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">antPathMatcher</span><span class="o">=</span><span class="k">new</span> <span class="nc">AntPathMatcher</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jwtUtil</span><span class="o">=</span><span class="n">jwtUtil</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>ApiCheckFilter ë‚´ë¶€ì˜ checkAuthHeader()ëŠ” ì•„ë˜ì™€ ê°™ì´ JWTUitlì˜ validateAndExtract()ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •í•œë‹¤.</p>

<p><br /></p>

<p><strong>ApiCheckFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkAuthHeader</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">){</span>
        <span class="kt">boolean</span> <span class="n">checkResult</span><span class="o">=</span><span class="kc">false</span><span class="o">;</span>


        <span class="c1">//í—¤ë”ì˜ ê°’ì„ ì¸ì¦í•˜ê¸° ìœ„í•´ì„œ Authorzation í—¤ë”ë¥¼ ì¶”ì¶œí•œë‹¤.</span>
        <span class="nc">String</span> <span class="n">authHeader</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">);</span>

        <span class="c1">//authHeader ë¬¸ìì—´ ë³€ìˆ˜ê°€ ë¬¸ìì—´ì„ í¬í•¨í•˜ëŠ”ì§€ ì²´í¬í•œë‹¤.</span>
        <span class="k">if</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">authHeader</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">authHeader</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"Bearer "</span><span class="o">)){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Authorization exist: "</span><span class="o">+</span><span class="n">authHeader</span><span class="o">);</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="nc">String</span> <span class="n">email</span><span class="o">=</span><span class="n">jwtUtil</span><span class="o">.</span><span class="na">validateAndExtract</span><span class="o">(</span><span class="n">authHeader</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">7</span><span class="o">));</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"validate result: "</span><span class="o">+</span><span class="n">email</span><span class="o">);</span>
                <span class="n">checkResult</span><span class="o">=</span><span class="n">email</span><span class="o">.</span><span class="na">length</span><span class="o">()&gt;</span><span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="c1">//if(authHeader.equals("12345678")){</span>
            <span class="c1">//"12345678"ì„ ë‹´ê³  ìˆìœ¼ë©´ trueë¥¼ ë‹´ëŠ”ë‹¤.</span>
            <span class="c1">//    checkResult=true;</span>
           <span class="c1">// }</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">checkResult</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>checkAuthHeader()ëŠ” ë‚´ë¶€ì—ì„œ â€˜Authorizationâ€™ í—¤ë”ë¥¼ ì¶”ì¶œí•´ì„œ ê²€ì¦í•˜ëŠ” ì—­í• ì„ í•œë‹¤. â€˜Authorizationâ€™ í—¤ë” ë©”ì‹œì§€ì˜ ê²½ìš° ì•ì—ëŠ” ì¸ì¦ íƒ€ì…ì„ ì´ìš©í•˜ëŠ”ë° ì¼ë°˜ì ì¸ ê²½ìš°ì—ëŠ” Basicì„ ì‚¬ìš©í•˜ê³  JWTë¥¼ ì´ìš©í•  ëŒ€ëŠ” â€˜Bearerâ€™ë¥¼ ì‚¬ìš©í•œë‹¤. SecurityConfigì—ì„œëŠ” ApiCheckFilterë¥¼ ì´ìš©í•  ë•Œ JWTUitlì„ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •í•œë‹¤.</p>

<p><br /></p>

<p><strong>SecurityConfig.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(...)</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ApiCheckFilter</span> <span class="nf">apiCheckFilter</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ApiCheckFilter</span><span class="o">(</span><span class="s">"/notes/**/*"</span><span class="o">,</span><span class="n">jwtUtil</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">(...)</span>
</code></pre></div></div>

<p><br /></p>

<p>ìµœì¢…ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ë„êµ¬ë¥¼ ì´ìš©í•´ì„œ í™•ì¸í•œë‹¤. ìš°ì„ ì€ GET ë°©ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” URLì„ ì‘ì„±í•˜ê³  Headerë¥¼ ì‘ì„±í•  ë•Œ â€˜Bearerâ€™ì™€ ê°™ì´ JWT í† í° ì•ì— ê³µë°± ë¬¸ìë¥¼ ì£¼ê³  JWT ë¬¸ìì—´ì„ ì¶”ê°€í•œë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-12-19-18-23.png" alt="" /></p>

<p><br /></p>

<p>í—¤ë”ê°€ ì •ìƒì ì¸ ê²½ìš°ì—ëŠ” ìœ„ ì‚¬ì§„ê³¼ ê°™ì´ ì •ìƒì ì¸ ì¡°íšŒê°€ ê°€ëŠ¥í•˜ë‹¤.</p>

<p>ë°˜ë©´ì— â€˜Authorizationâ€™ì„ ì œê±°í•œ ìƒíƒœì—ì„œ ì‹¤í–‰í•˜ë©´ 403 ìƒíƒœ ì½”ë“œ(ìš”ì²­ì´ ê±°ë¶€ë¨)ì™€ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-12-19-19-17.png" alt="" /></p>

<p><br />
<br /></p>

<p><span style="color:#85144b; font-weight:bold; font-size: 30px">CORS í•„í„° ì²˜ë¦¬</span></p>

<p><br /></p>

<p>REST ë°©ì‹ì˜ í…ŒìŠ¤íŠ¸ëŠ” ëª¨ë‘ ì„±ê³µí–ˆì§€ë§Œ ê²°ì •ì ìœ¼ë¡œ ì™¸ë¶€ì—ì„œ Ajaxë¥¼ ì´ìš©í•´ì„œ APIë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” CORS(Cross-Origin Resource Sharing) ë¬¸ì œë¥¼ í•´ê²°í•´ì•¼ë§Œ í•œë‹¤.
CORS ì²˜ë¦¬ë¥¼ ìœ„í•œ í•„í„°ë¥¼ ë§Œë“¤ê±°ë‚˜ ì„¤ì •í•˜ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆê² ì§€ë§Œ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì§€ê¸ˆê» ì‘ì„±í–ˆë” ì˜ˆì œì²˜ëŸ¼ ì¶”ê°€í•˜ëŠ” í˜•íƒœë¡œ ì‘ì„±í•œë‹¤.</p>

<p><br /></p>

<p><img src="/images/SpringBoot/LearningSpringbootWithWebProject-12.3/2021-08-12-19-33-04.png" alt="" /></p>

<p><br /></p>

<p><strong>CORSFilter.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.young.club.security.filter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.core.Ordered</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.annotation.Order</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.filter.OncePerRequestFilter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="nd">@Order</span><span class="o">(</span><span class="nc">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">)</span>
<span class="c1">//OncePerRequestFilterëŠ” ì¶”ìƒ í´ë˜ìŠ¤ë¡œ ì œê³µë˜ëŠ” í•„í„°ë¡œ ê°€ì¥ ì¼ë°˜ì ì´ë©° ë§¤ë²ˆ ë™ì‘í•˜ëŠ” ê¸°ë³¸ì ì¸ í•„í„°ì´ë‹¤.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CORSFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">//ëª¨ë“  ì˜¤ë¦¬ì§„ìœ¼ë¡œë¶€í„° APIìš”ì²­ì„ ìˆ˜ë½í•œë‹¤.</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Origin"</span><span class="o">,</span> <span class="s">"*"</span><span class="o">);</span>
        <span class="c1">//ë¸Œë¼ìš°ì €ì—ê²Œ responseë¥¼ requestì˜ credentials modeê°€ í¬í•¨ë  ë•Œ í”„ë¡ íŠ¸ì—”ë“œ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œì— ë…¸ì¶œì‹œí‚¬ì§€ ê²°ì •í•œë‹¤</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Credentials"</span><span class="o">,</span><span class="s">"true"</span><span class="o">);</span>
        <span class="c1">//(that is the information contained in the Access-Control-Allow-Methods and Access-Control-Allow-Headers headers)</span>
        <span class="c1">//response í—¤ë” ì¤‘ í•˜ë‚˜ë¡œ ì–¼ë§ˆë‚˜ ì˜¤ë˜ë™ì•ˆ preflight request(Access-Control-Allow-Methodsì™€ Access-Control-Allow-Headers í—¤ë”ì˜ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆëŠ”)ê°€ ìºì‹±ë  ì§€ ì‹œê°„ì„ ì •í•œë‹¤.</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Max-Age"</span><span class="o">,</span><span class="s">"3600"</span><span class="o">);</span>
        <span class="c1">//response í—¤ë” ì¤‘ í•˜ë‚˜ë¡œ preflight requestì˜ responseë¡œ ì“°ì´ë©° ì´ëŠ” ì–´ë–¤ HTTP í—¤ë”ê°€ ì‹¤ì œ request ë„ì¤‘ì— ì‚¬ìš©ë  ìˆ˜ ìˆëŠ”ì§€ ëª…ì‹œí•˜ëŠ” Access-Control-Request-Headersë¥¼ í¬í•¨í•œë‹¤.</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Headers"</span><span class="o">,</span><span class="s">"Origin, X-Requested-With, Content-Type, Accept, Key, Authorization"</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="s">"OPTIONS"</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">())){</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_OK</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span><span class="n">response</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><br /></p>

<p>CORSFilterëŠ” ëª¨ë“  í•„í„° ì¤‘ì—ì„œ ê°€ì¥ ë¨¼ì € ë™ì‘í•˜ë„ë¡ @Order(Ordered.HIGHEST_PRECEDENCE)ë¡œ ì§€ì •í•œë‹¤. ë§Œì¼ jQueryë¡œ ì™¸ë¶€ì—ì„œ <strong>â€˜/notes/xxxâ€™</strong>ë¥¼ ì´ìš©í•œë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•˜ê²Œ ëœë‹¤.</p>

<p><br /></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.btn</span><span class="dl">"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()){</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="na">beforeSend</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">){</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Bearer </span><span class="dl">'</span><span class="o">+</span><span class="nx">jwtValue</span><span class="p">);</span>
            <span class="c1">//jwtValueëŠ” JWTê°’</span>
        <span class="p">},</span>
        <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">json</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:8080/notes/all</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">data</span><span class="p">:{</span><span class="na">email</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user10@zerock.org</span><span class="dl">'</span><span class="p">},</span>
        <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arr</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arr</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">})</span>

</code></pre></div></div>
:ET